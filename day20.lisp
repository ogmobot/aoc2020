(defconstant +last-index+ 9)
(defconstant +tile-size+ 8)
(defconstant +buffer-size+ 96)
; tile structure:
; (:id 2311 :data ("###" ... "###") :orientation 0)
; (getf tile :data) is a list of ten lenth-10 strings

; orientations
; 0 (unchanged) ab  4 (flipped) ad
;               dc              bc

; 1 (90 cwise)  da  5           ba
;               cb              cd

; 2 (180 cwise) cd  6           cb
;               ba              da

; 3 (270 cwise) bc  7           dc
;               ad              ab

(defun load-all (filename)
    ; returns a list of tiles
    (with-open-file (stream filename)
            (loop for line = (read-line stream nil)
                while line
                collect (list
                    :id (parse-integer (subseq line 5) :junk-allowed t)
                    :data (loop for line = (read-line stream nil)
                            while (and line (not (string= line "")))
                            collect line)
                    :orientation 0))))

(defun raw-top (tile)
    ; returns top row LEFT-TO-RIGHT in orientation 0 (a->b)
    (car (getf tile :data)))

(defun raw-bottom (tile)
    ; returns bottom row RIGHT-TO-LEFT in orientation 0 (c->d)
    (reverse (nth +last-index+ (getf tile :data))))

(defun raw-right (tile)
    ; returns right row TOP-TO-BOTTOM in orientation 0 (b->c)
    (format nil "撖狺磲疸狎灬礅溽蝻鳗ㄣ栳蝻灬篝轭溴┅ㄧ弭糸戾轰狒岍┅ㄤ彐躅蜥鳝戾骠糸戾蝈趱蝾蜷玷蝻孪栽贤韵韵轭矧殄铘狒轱ㄤ踞ㄦ矧磲铋撖狺磲疸狎灬礅溽蝻鳗ㄣ栳蝻癌蝈鲥蝮ㄧ弭糸戾轰狒岍┅┅ㄤ彐躅蝈飙麸糸戾蝈趱蝾麸蝻轭玳鲥矧殄铘狒轱ㄣ狍ㄧ弭糸戾猴蜷孱翎糸镱ò蜥鳝麸糸戾┅ù蝈鲥蝮蜥鳝戾骠糸戾┅ū蜥鳝戾骠糸戾┅ǖ蝈鲥蝮蜥鳝麸糸戾┅ú蜥鳝怙趑镯糸戾┅ǘ蝈鲥蝮蜥鳝蜷玷糸戾┅ǔ蜥鳝蜷玷糸戾┅ǚ蝈鲥蝮蜥鳝怙趑镯糸戾┅┅ㄤ彐躅蝈飙怙趑镯糸戾蝈趱蝾怙趑镯蝻轭玳鲥矧殄铘狒轱ㄣ狍ㄧ弭糸戾猴蜷孱翎糸镱ò蜥鳝怙趑镯糸戾┅ù蝈鲥蝮蜥鳝蜷玷糸戾┅ū蜥鳝蜷玷糸戾┅ǖ蝈鲥蝮蜥鳝怙趑镯糸戾┅ú蜥鳝麸糸戾┅ǘ蝈鲥蝮蜥鳝戾骠糸戾┅ǔ蜥鳝戾骠糸戾┅ǚ蝈鲥蝮蜥鳝麸糸戾┅┅ㄤ彐躅蝈飙蜷玷糸戾蝈趱蝾蜷玷蝻轭玳鲥矧殄铘狒轱ㄣ狍ㄧ弭糸戾猴蜷孱翎糸镱ò蜥鳝蜷玷糸戾┅ù蝈鲥蝮蜥鳝怙趑镯糸戾┅ū蜥鳝麸糸戾┅ǖ蝈鲥蝮蜥鳝戾骠糸戾┅ú蜥鳝戾骠糸戾┅ǘ蝈鲥蝮蜥鳝麸糸戾┅ǔ蜥鳝怙趑镯糸戾┅ǚ蝈鲥蝮蜥鳝蜷玷糸戾┅┅ㄤ彐躅蝈飙戾骠糸戾蝈趱蝾戾骠蝻轭玳鲥矧殄铘狒轱ㄣ狍ㄧ弭糸戾猴蜷孱翎糸镱ò蜥鳝戾骠糸戾┅ù蝈鲥蝮蜥鳝麸糸戾┅ū蜥鳝怙趑镯糸戾┅ǖ蝈鲥蝮蜥鳝蜷玷糸戾┅ú蜥鳝蜷玷糸戾┅ǘ蝈鲥蝮蜥鳝怙趑镯糸戾┅ǔ蜥鳝麸糸戾┅ǚ蝈鲥蝮蜥鳝戾骠糸戾┅┅ㄤ彐躅痨徙瀛犰飙糸戾糸戾糸戾磲皓痨徙骈蝮糸戾箦翩ㄧ弭栳箬ㄣ镱癌糸戾磲皓ㄣ狎糸戾螬箦翩糸戾ㄣ潋糸戾螬痨徙蝈磲轭轭糸戾祜镳麒殪戾铉翳糸戾螬癌讳ㄦ矧磲Ⅳ殪弩誉ア糸戾螬滹祜镳钺礤遽汨糸戾骘忮轭翳栳箬脲躞轭ㄨ狍璀鲠祯雯镦糸戾磲滹戾è徕秭瀛箴徙ㄣ镱ㄣ狎氅ōㄣ潋氅暴┅ㄢ屐秣箴徙ㄣ镱ㄣ狎氅ǐㄣ潋氅暴┅戾骠箴徙ㄣ镱ōㄣ狎氅暴ㄣ潋氅┅蜷玷舡箴徙ㄣ镱ǐㄣ狎氅暴ㄣ潋氅┅祜镳骘轭扉篝扉篝后疳沐徕秭瀛箴徙衡狍瀛骖＇蝈飙麸侯鬻骖＇蝈飙怙趑镯扉篝后疳沐忮祜鳝箴徙衡狍瀛骖＇蝈飙怙趑镯侯鬻骖＇蝈飙麸皓扉篝后疳沐戾骠箴徙衡狍瀛骖＇蝈飙戾骠侯鬻骖＇蝈飙蜷玷舂扉篝后疳沐蜷玷舡箴徙衡狍瀛骖＇蝈飙蜷玷侯鬻骖＇蝈飙戾骠┅麒孱铛祆ㄧ弭栳箬ㄧ弭后疳沐糸戾磲皓趄麸骈痖邈轭滹祜镳骘汜钿殇狒轭糸戾滹祜镳骘矧骝镯躔麸滹痱镧箦翩ㄧ弭汜钿殇狒猴蜷孱翎糸镱矧椹ㄩ篝蜷铉ㄦ躅汜祆ㄧ弭衡狍瀛骖雯蝈鲥蝮ㄦ躅汜祆ㄧ弭侯鬻骖汜钿殇狒濠┅痱镧箦翩ㄧ弭栳箬ㄧ弭后疳沐糸戾磲皓汜钿殇狒濠箦翩糸戾蝈盹鲥汜钿殇狒糸戾螬蝈趱蝾骝镯遽汨糸戾ㄧ弭后疳沐┅┅┅┅┅糸戾磲皓ㄤ彐躅珏舡屮趄屙弩糸戾磲皓祜镳骘忮轭翳栳箬脲镦糸戾磲黹铋黹轭ㄣ狎氅轭麸黹瞽磲轫辁轭ㄣ狎氅轭麸磲黹铋黹轭ㄣ潋氅轭麸黹瞽磲轫辁轭ㄣ潋氅轭麸磲骈钺祆蝈趱蝾扉篝黹瞽磲黹瞽磲┅┅ㄤ彐躅糸戾磲瓠麸怩骀弪糸戾磲皓戾舄è屮趄屙弩ㄧ弭屮趄屙弩糸戾磲皓黹瞽ㄣ狎屮趄屙弩┅黹瞽ㄣ徜潋屮趄屙弩┅ㄢ蹑驽磲脲狎蜥啜怩骀弪箝瀚怩骀弪箝瀚哄戾礤铘豉疱с栳蜥泗弪洪铋糸犰屐屙孱＼┅祜镳骘忮轭翳栳箬脲躞轭ㄨ狍璀鲠祯雯镦糸戾磲骘ㄣ狎氅骘ㄣ潋氅滹祜镳骘蜷钿屮骝镯躔麸ō糸戾箝瀚暴滹祜镳骘汩钿屮骝镯躔麸ō糸戾箝瀚暴滹戾舄èㄧ弭轰狒岍ㄣㄣ狍ㄧ弭猴蜷孱翎糸镱南围韵彰òㄣ栳铘ǐ蜷钿屮愆ǐ汩钿屮┅ūㄣ栳铘ǐ汩钿屮蝈鲥蝮愆ǐ蜷钿屮┅úㄣ栳蝈鲥蝮铘ǐ蜷钿屮蝈鲥蝮愆┅ǐ汩钿屮┅ǔㄣ栳蝈鲥蝮铘ǐ汩钿屮愆ǐ蜷钿屮┅ùㄣ栳铘ǐ汩钿屮愆ǐ蜷钿屮┅ǖㄣ栳蝈鲥蝮铘ǐ蜷钿屮愆ǐ汩钿屮┅ǘㄣ栳蝈鲥蝮铘ǐ汩钿屮蝈鲥蝮愆┅ǐ蜷钿屮┅ǚㄣ栳铘ǐ蜷钿屮蝈鲥蝮愆ǐ汩钿屮┅雉桢蝼轶＼┅┅箦翩ㄡ蝈怩骀弪ǐ蜷钿屮í糸戾箝瀚ō黹瞽┅ǐ汩钿屮í糸戾箝瀚ō黹瞽┅┅汨┅┅怩骀弪┅ㄤ彐躅溟箴灬怩骀弪ㄢ蹑驽颟祜镳骘蝻骝镯躔麸ō怩骀弪箝瀚暴滹祜镳骘泔骝镯躔麸ō怩骀弪箝瀚暴滹ㄦ矧磲恽ㄡ蝈怩骀弪蝻泔飑┅滹ㄦ矧磲ア┅ㄤ彐躅蝻翎翦狎蜥ㄡ戾舄è铛憝蝻黧ㄣ狎ㄡ蝌狴溟礤铙轱铙岍┅铛憝泔祗ㄣ徜ㄡ蝌狴溟礤铙轱铙岍┅蝈篚祠狎蜥磲脲狎蜥扉篝铛憝泔祗铛憝蝻黧哄戾礤铘豉疱с栳蜥泗弪洪铋糸犰屐屙孱＼┅祜镳骘蝻骝镯躔麸ō铛憝蝻黧暴滹祜镳骘泔骝镯躔麸ō铛憝泔祗暴滹箦翩ㄡ蝈蝈篚祠狎蜥泔ō铛憝蝻黧ǐ蝻暴┅ㄡ蝈蝻泔飑┅蝈篚祠狎蜥┅ㄤ彐躅骒轲狎蜥ㄡ戾舄è铛憝蝻黧ㄣ狎ㄡ蝌狴溟礤铙轱铙岍┅铛憝泔祗ㄣ徜ㄡ蝌狴溟礤铙轱铙岍┅蝈篚祠狎蜥磲脲狎蜥扉篝铛憝泔祗铛憝蝻黧哄戾礤铘豉疱с栳蜥泗弪洪铋糸犰屐屙孱＼┅祜镳骘蝻骝镯躔麸ō铛憝蝻黧暴滹祜镳骘泔骝镯躔麸ō铛憝泔祗暴滹箦翩ㄡ蝈蝈篚祠狎蜥泔蝻鳗ㄡ蝈蝻泔飑┅蝈篚祠狎蜥┅ㄤ彐躅磲脲潋徵镱磲箅矧殄铘狒轱瞟戾è潋徵镱磲脲狎蜥Ж舶哄戾礤铘豉疱с栳蜥泗弪洪铋糸犰泔铘孱趔Ж＃＃＃＂┅┅ㄣ狍矧殄铘狒轱ò潋徵镱ū蝻翎翦狎蜥潋徵镱┅ú蝻翎翦狎蜥蝻翎翦狎蜥潋徵镱┅ǔ蝻翎翦狎蜥蝻翎翦狎蜥蝻翎翦狎蜥潋徵镱┅┅ùㄦ扉瓠狎蜥潋徵镱┅ǖ蝻翎翦狎蜥ㄦ扉瓠狎蜥潋徵镱┅ǘ蝻翎翦狎蜥蝻翎翦狎蜥ㄦ扉瓠狎蜥潋徵镱┅┅ǚ蝻翎翦狎蜥蝻翎翦狎蜥蝻翎翦狎蜥ㄦ扉瓠狎蜥潋徵镱┅┅┅┅ㄤ彐躅骈钿箦岘潋徵镱ㄢ蹑驽颟狍篚礤铒秭弪灬痧轭潋徵镱螽祜镳骘矧殄铘狒轱骝镯躔麸滹戾舄è潋徵镱磲箅磲脲潋徵镱磲箅矧殄铘狒轱瞟铛憝蝻黧ㄣ狎ㄡ蝌狴溟礤铙轱铙潋徵镱磲箅┅铛憝泔祗ㄣ徜ㄡ蝌狴溟礤铙轱铙潋徵镱磲箅┅┅祜镳骘镦骟弭骝镯躔麸ō怩骀弪箝瀚铛憝泔祗滹祜镳骘镦骟弭骝镯躔麸ō怩骀弪箝瀚铛憝蝻黧汨邈骘潋徵镱狒翳轶祜汜糸镱麒孱祜镳钺礤潋徵镱汨邈骘蝻骝镯躔麸ō铛憝蝻黧暴滹祜镳骘泔骝镯躔麸ō铛憝泔祗暴麒孱ㄡ钿ㄣ栳蚪ㄡ蝈潋徵镱磲箅蝻泔飑＼）ㄣ栳蚪ㄡ蝈怩骀弪ǐ镦骟弭蝻鳗ǐ镦骟弭泔飑＼┅铒潋徵镱滹蝈趱蝾骝镯潋徵镱汨邈铋飑骈钺祆蝈趱蝾骝镯潋徵镱汨邈舂潋徵镱屮轶趔滹祜镳骘蝻骝镯躔麸ō铛憝蝻黧暴滹祜镳骘泔骝镯躔麸ō铛憝泔祗暴麒孱ㄣ栳蚪ㄡ蝈潋徵镱磲箅蝻泔飑＼）滹箦翩ㄡ蝈怩骀弪ǐ镦骟弭蝻鳗ǐ镦骟弭泔飑＼烯┅┅┅怩骀弪戾è糸戾祜徜犰ｐ㈤铕豸舶豇簪┅糸戾磲磲脲栳箬翎忪呼弩＇羼踽飑┅痨徙瀛犰飙糸戾糸戾糸戾磲皓疳螋花骘蝽狒誉ア糸戾磲皓戾舄è屮趄屙弩ㄧ弭屮趄屙弩糸戾磲皓黹瞽ㄣ狎屮趄屙弩┅磲ㄣ徜屮趄屙弩┅黹瞽ㄣ徜潋屮趄屙弩┅磲ㄣ徜滗屮趄屙弩┅ㄣ矧铄蝮扉篝ㄣ镱黹瞽黹瞽ㄣ镱磲黹瞽ㄣ镱黹瞽磲ㄣ镱磲磲┅┅ㄦ矧磲狺アㄡ痧禊И磲疸狎灬礅溽氅ㄧ弭ㄧ弭栳箬糸戾磲皓洪洎泔蝾弪螬┅疳螋戾è怩骀弪糸戾磲瓠麸怩骀弪糸戾磲皓┅ㄦ轭洵箦岘潋徵镱怩骀弪花溟箴灬怩骀弪怩骀弪ㄦ矧磲狺ア祜镳骘蝻骝镯躔麸ō怩骀弪箝瀚暴篚祜镳骘泔骝镯躔麸ō怩骀弪箝瀚暴泔躅ㄣ栳蚪ㄡ蝈怩骀弪蝻泔飑＼）┅┅